const $ = document.querySelector.bind(document);
const $$ = document.querySelectorAll.bind(document);

const PLAYER_STORAGE_KEY = 'Ng·ªçc Ph√∫';

// khai b√°o bi·∫øn.
const player = $('.player');
const heading = $('.name-song');
const singer = $('.name-singer')
const cdThumb = $('.cd-thumb');
const audio = $('#audio');
const playBtn = $('.btn-toggle-play');
const progressBar = $('.progress-bar');
const progress = $('#progress');
const songDuration = $('.progress-time__duration');
const songCurrentTime = $('.progress-time__current-time');
const nextBtn = $('.btn-next');
const prevBtn = $('.btn-prev');
const randomBtn = $('.btn-random');
const repeatBtn = $('.btn-repeat');
const listMussic = $('.playlist-mussic');

const app = {
    currentIndex: 0, 
    isPlaying: false,
    isRandom: false,
    isRepeat: false,
    isHoldProgressBar: false,
    config: JSON.parse(localStorage.getItem(PLAYER_STORAGE_KEY)) || {},
    songs : [
        { 
            name: 'ƒê·ªùi L√† Th·∫ø Th√¥i',
            author: 'Ph√∫ L√™ n√†o ch·ª© kh√¥ng ph·∫£i m√¨nhü•≤',
            path: './assets/css/music/song0.mp3',
            image: './assets/css/img/img0.jpg',
        },
        { 
            name: '2 Ph√∫t H∆°n - Ph√°o',
            author: 'Masew',
            path: './assets/css/music/song1.mp3',
            image: './assets/css/img/img1.jpg',
        },
        { 
            name: 'Thanh Xu√¢n',
            author: 'Da LAB',
            path: '../assets/css/music/song2.mp3',
            image: './assets/css/img/img2.jpg',
        },
        { 
            name: 'ƒê·ª´ng H·ªèi Em',
            author: 'M·ªπ T√¢m',
            path: './assets/css/music/song3.mp3',
            image: './assets/css/img/img3.jpg',
        },
        { 
            name: 'Hoa N·ªü Kh√¥ng M√†u',
            author: 'Ho√†i L√¢m',
            path: './assets/css/music/song4.mp3',
            image: './assets/css/img/img4.jpg',
        },
        { 
            name: 'N√†ng Th∆°',
            author: 'Ho√†ng D≈©ng',
            path: './assets/css/music/song5.mp3',
            image: './assets/css/img/img5.jpg',
        },
        { 
            name: 'L·∫† L√ôNG',
            author: 'V≈©',
            path: './assets/css/music/song6.mp3',
            image: './assets/css/img/img6.png',
        },
        { 
            name: '√Çm Th·∫ßm B√™n Em',
            author: 'S∆°n T√πng-MTP',
            path: './assets/css/music/song7.mp3',
            image: './assets/css/img/img7.jpg',
        },
        { 
            name: 'M∆° H·ªì',
            author: 'B√πi Anh Tu·∫•n',
            path: './assets/css/music/song8.mp3',
            image: './assets/css/img/img8.jpg',
        },
        { 
            name: 'Th√°ng T∆∞ L√† L·ªùi N√≥i D·ªëi C·ªßa Em',
            author: 'H√† Anh Tu·∫•n',
            path: './assets/css/music/song9.mp3',
            image: './assets/css/img/img9.jpg',
        },
        { 
            name: ' B√†i N√†y Chill Ph·∫øt',
            author: 'ƒêen ft. MIN',
            path: './assets/css/music/song10.mp3',
            image: './assets/css/img/img10.jpg',
        },
        { 
            name: ' C√°nh H·ªìng Phai',
            author: 'Qu·ªëc Thi√™n',
            path: './assets/css/music/song11.mp3',
            image: './assets/css/img/img11.jpg',
        },
        { 
            name: 'Ch·ªâ L√† Kh√¥ng C√πng Nhau',
            author: 'TƒÇNG PH√öC ft TR∆Ø∆†NG TH·∫¢O NHI',
            path: './assets/css/music/song12.mp3',
            image: './assets/css/img/img12.jpg',
        },
        { 
            name: 'Despacito',
            author: 'Luis Fonsi if Daddy Yankee',
            path: './assets/css/music/song13.mp3',
            image: './assets/css/img/img13.webp',
        },
        { 
            name: 'Th·∫±ng ƒêi√™n',
            author: 'JUSTATEE x PH∆Ø∆†NG LY',
            path: './assets/css/music/song14.mp3',
            image: './assets/css/img/img14.jpg',
        },
        { 
            name: 'N∆°i N√†y C√≥ Anh',
            author: 'MTP',
            path: './assets/css/music/song15.mp3',
            image: './assets/css/img/img15.jpg',
        },
        { 
            name: 'L·ªëi Nh·ªè',
            author: 'ƒêen',
            path: './assets/css/music/song16.mp3',
            image: './assets/css/img/img16.jpg',
        },
        { 
            name: 'Thu Cu√¥ÃÅi',
            author: 'Mr.T ft Yanbi & HƒÉÃÄng Bingboong',
            path: './assets/css/music/song17.mp3',
            image: './assets/css/img/img17.jpg',
        },
        { 
            name: 'M√åNH C∆Ø·ªöI NHAU ƒêI',
            author: 'Pjnboys x Hu·ª≥nh James',
            path: './assets/css/music/song18.mp3',
            image: './assets/css/img/img18.jpg',
        },
        { 
            name: 'Cho H·ªç Gh√©t ƒêi Em',
            author: 'Pjnboys x Hu·ª≥nh James',
            path: './assets/css/music/song19.mp3',
            image: './assets/css/img/img19.jpg',
        },
    ],
    setConfig:function(key , value) {
        this.config[key] = value;
        localStorage.setItem(PLAYER_STORAGE_KEY, JSON.stringify(this.config))
    },
    defineProperties:function () {
        Object.defineProperty(this, 'currentSong',{
            get:function () {
                return this.songs[this.currentIndex]
            }
        });
    },
    // time format
    timeFormat(seconds){
        const date = new Date(null)
        date.setSeconds(seconds)
        return date.toISOString().slice(14, 19)
    },
    // render ra web + app
    render: function () {
        const htmls = this.songs.map((song, index) => {
            return`
                 <div class="song ${index === this.currentIndex ? 'addition':''}" data-index="${index}">
                    <div class="thumb">
                        <img alt="" class="cd__img" src="${song.image}">
                    </div>
                    <div class="body-list">
                        <h5 class="title">${song.name}</h5>
                        <p class="author">${song.author}</p>
                    </div>
                    <div class="option">
                        <span id="icon-menu-form"class="material-icons">more_vert</span>
                    </div>
                </div> 
            `
        })
        listMussic.innerHTML = htmls.join('')
    },
    handleEvents: function () {
        const _this = this;
        // xoay img 
        const cdThumbAnimate = cdThumb.animate([
            {transform: 'rotate(360deg)'}
        ],{
            duration: 10000,// 10s
            iterations:Infinity
        })
        cdThumbAnimate.pause()
        // click play
        playBtn.onclick = function () {
            if(_this.isPlaying) {
                audio.pause()
            } else {
                audio.play()
            }
        }
        audio.onplay = function () {
            _this.isPlaying = true;
            player.classList.add('playing')
            cdThumbAnimate.play()
        }
        audio.onpause = function () {
            _this.isPlaying = false;
            player.classList.remove('playing')
            cdThumbAnimate.pause()
        }
        // khi ti·∫øn ƒë·ªô b√†i h√°t thay ƒë·ªïi
        // audio.ontimeupdate = function () {
        //     if(audio.duration) {
        //         const progressPercent = Math.floor(audio.currentTime / audio.duration*100)
        //         progress.value = progressPercent
        //     }
        // }
        audio.ontimeupdate = function() {
            songCurrentTime.textContent = _this.timeFormat(this.currentTime)
            const progressPercent = this.currentTime / this.duration * 100
            progress.style.width = progressPercent + '%'
        }
        // 
        progressBar.onmousedown = function(e) {
            audio.currentTime = e.offsetX / this.offsetWidth * audio.duration
            // ƒê·∫∑t c√°i n√†y ƒë·ªÉ l√†m ƒë∆∞·ª£c v·ª´a gi·ªØ v·ª´a k√©o
            _this.isHoldProgressBar = true
        }
        progressBar.onchange = function(e) {
            if(_this.isHoldProgressBar){
                audio.currentTime = e.offsetX / this.offsetWidth * audio.duration
            }
        }
        // x·ª≠ l√Ω khi tua song
        // progress.onchange = function (e) {
        //     const seekTime = audio.duration / 100 * e.target.value;
        //     audio.currentTime = seekTime
        // }
        // x·ª≠ l√Ω khi next v√† l√πi b√†i h√°t
        nextBtn.onclick = function (){
            if(_this.isRandom) {
                _this.playRandomSong()
            } else{
                _this.nextSong()
            }
            audio.play();
            _this.render();
            _this.scrollToActiveSong();
        }
        prevBtn.onclick = function () {
            if(_this.isRandom) {
                _this.playRandomSong()
            } else{
                _this.prevSong()
            }
            audio.play()
            _this.render()
            _this.scrollToActiveSong();
        }
        // khi random b√†i h√°t 
        randomBtn.onclick = function () {
            _this.isRandom = !_this.isRandom
            _this.setConfig('isRandom',_this.isRandom)
            randomBtn.classList.toggle('active', _this.isRandom);
        }
        // x·ª≠ l√Ω l·∫∑p l·∫°i 1 b√†i h√°t
        repeatBtn.onclick = function () {
            _this.isRepeat = !_this.isRepeat
            _this.setConfig('isRepeat',_this.isRepeat)
            repeatBtn.classList.toggle('active', _this.isRepeat);
        }
        // x·ª≠ l√Ω Next b√†i h√°t khi k·∫øt th√∫c b√†i 
        audio.onended = function () {
            if(_this.isRepeat) {
                audio.play()
            }else {
                nextBtn.click()
            }
        }
        // x·ª≠ l√Ω h√†nh vi ng∆∞·ªùi d√πng click v√†o b√†i h√°t
        listMussic.onclick = function (e) {
            const songOption = e.target.closest('.song:not(.addition)');
            if(songOption || e.target.closest('.option')) {
                // khi click v√†o b√†i h√°t ƒë∆∞·ª£c ch·ªçn
                if (songOption){
                    _this.currentIndex = Number(songOption.dataset.index);
                    _this.loadCurrentSong();
                    _this.render()
                    audio.play();
                }
                // Khi click v√†o icon option
                if(e.target.closest('.option')) {

                }
            }
        }
    },
    // h√†m loading b√†i h√°t ra giao di·ªán.
    scrollToActiveSong: function () {
        setTimeout(() => {
            $('.song.addition').scrollIntoView({
                behavior:'smooth',
                block:'center',
                inline: 'center'
            })
        },300)
    },
    loadCurrentSong: function () {
        heading.textContent = this.currentSong.name;
        singer.textContent = this.currentSong.author;
        cdThumb.style.backgroundImage = `url('${this.currentSong.image}')`;
        audio.src = this.currentSong.path;
        

        // X·ª≠ l√Ω l·∫•y ti·∫øn tr√¨nh v√† th·ªùi l∆∞·ª£ng b√†i h√°t tr∆∞·ªõc khi ph√°t
        const _this = this
        audio.onloadedmetadata = function(){
            songCurrentTime.textContent = _this.timeFormat(this.currentTime.toFixed(2))
            songDuration.textContent = _this.timeFormat(this.duration.toFixed(2))
        }
    },
    loadConfig: function () {
        this.isRandom = this.config.isRandom;
        this.isRepeat = this.config.isRepeat;
        // Object.assign(this , this.config)
    },
    nextSong:function() {
        this.currentIndex++
        if(this.currentIndex >= this.songs.length) {
            this.currentIndex = 0;
        }
        this.loadCurrentSong()
    },
    prevSong:function () {
        this.currentIndex--
        if(this.currentIndex < 0) {
            this.currentIndex = this.song.length - 1;
        }
        this.loadCurrentSong()
    },
    playRandomSong: function (){
        let newIndex = this.currentIndex;
        do {
            newIndex = Math.floor(Math.random()*this.songs.length)
        } while (newIndex === this.currentIndex)
        this.currentIndex = newIndex;
        this.loadCurrentSong()
    },
    start: function () {
        const _this = this;

        // loading c·∫•u h√¨nh 
        this.loadConfig()
        // ƒë·ªãnh nghƒ©a properties
        this.defineProperties()
        // x·ª≠ l√Ω logic 
        this.handleEvents()
        // loading update mussic render web
        this.loadCurrentSong()
        this.nextSong()
        this.render()
        // Actice tr·∫°ng th√°i element repeat & radom
        randomBtn.classList.toggle('active', _this.isRandom);
        repeatBtn.classList.toggle('active', _this.isRepeat);
    }
}
app.start()